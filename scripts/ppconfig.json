{"name":"daefabbbfa","url":"https://jellyfishiland.netlify.app/","showName":"Jellyfish","appid":"com.jellyfishiland.app","icon":"","iconPath":"C:\\Users\\Administrator\\AppData\\Roaming\\com.pakeplus.pacbao\\daefabbbfa.png","iconRound":true,"state":true,"single":true,"injectJq":true,"tauriApi":false,"devbug":false,"version":"0.0.1","preview":"desktop","platform":["1-1"],"width":800,"height":600,"desc":"","jsFile":[],"filterCss":"","customJs":"// very important, if you don't know what it is, don't touch it\n// 非常重要，不懂代码不要动，这里可以解决80%的问题，也可以生产1000+的bug\n\n// (原始逻辑保持不变，用于处理页面内跳转)\nconst hookClick = (e) => {\n    // 寻找点击目标最近的 <a> 标签\n    const origin = e.target.closest('a');\n    \n    // ----------- [关键修改点 1: 增加下载链接判断] -----------\n    // 如果这个链接是下载链接(有download属性)，则直接退出，交由下面的 hookDownload 函数处理\n    if (origin && origin.hasAttribute('download')) {\n        return; \n    }\n    // ---------------------- [修改结束] ----------------------\n\n    const isBaseTargetBlank = document.querySelector(\n        'head base[target=\"_blank\"]'\n    );\n    console.log('origin', origin, isBaseTargetBlank);\n    \n    if (\n        (origin && origin.href && origin.target === '_blank') ||\n        (origin && origin.href && isBaseTargetBlank)\n    ) {\n        e.preventDefault();\n        console.log('handle origin', origin);\n        location.href = origin.href;\n    } else {\n        console.log('not handle origin', origin);\n    }\n};\n\nwindow.open = function (url, target, features) {\n    console.log('open', url, target, features);\n    location.href = url;\n};\ndocument.addEventListener('click', hookClick, { capture: true });\n\n\n// ----------- [关键修改点 2: 新增专门处理下载的模块] -----------\n// 将您找到的两段代码整合并重构为一个完整的下载模块\n(function () {\n    // 首先检查是否在 Tauri 环境中，如果不是，则不执行任何操作\n    if (!('__TAURI__' in window)) {\n        return;\n    }\n\n    console.log(\"Tauri 环境检测成功，下载模块已初始化。\");\n\n    // 从 Tauri API 中解构出需要的函数\n    const { invoke } = window.__TAURI__.core;\n    const { listen } = window.__TAURI__.event;\n    const { message } = window.__TAURI__.dialog; // 新增：用于简单的弹窗提示\n\n    // [重构] 创建一个 Set 来跟踪正在下载的文件 ID，防止重复处理\n    const downloadingFiles = new Set();\n    \n    // 设置事件监听器，用于接收后端的下载进度\n    listen('download_progress', (event) => {\n        const { fileId, downloaded, total } = event.payload;\n\n        // 如果这个文件ID是我们正在跟踪的，就更新它的进度\n        if (downloadingFiles.has(fileId)) {\n            const progress = total > 0 ? ((downloaded / total) * 100).toFixed(0) : 0;\n            console.log(`文件[${fileId}] 下载进度: ${progress}%`); // 您可以在这里更新UI\n            \n            // 示例：如果您的页面有一个全局的顶部提示条，可以这样更新\n            if (typeof showTopToast === 'function') {\n                showTopToast(`下载中... ${progress}%`, 60000); // 长时间显示\n            }\n        }\n    });\n\n    // 创建一个新的下载点击事件钩子\n    const hookDownload = async (e) => {\n        const downloadLink = e.target.closest('a[download]');\n\n        // 如果点击的不是下载链接，或者已经在处理一个下载，则直接返回\n        if (!downloadLink) {\n            return;\n        }\n\n        // 阻止浏览器的默认下载行为\n        e.preventDefault();\n        \n        const urlToDownload = downloadLink.href;\n        const defaultFilename = downloadLink.download || 'downloaded-file';\n        \n        // 生成一个唯一的文件ID用于跟踪\n        const fileId = `file_${Date.now()}`;\n        \n        if (downloadingFiles.has(fileId)) {\n            console.log('该文件已在下载队列中。');\n            return;\n        }\n\n        try {\n            // [重构] 开始下载\n            downloadingFiles.add(fileId);\n            if (typeof showTopToast === 'function') {\n                showTopToast('已开始下载，请在系统下载文件夹查看...', 3000);\n            } else {\n                console.log('已开始下载，请在系统下载文件夹查看...');\n            }\n\n            // 使用 invoke 调用 Pake Plus 提供的自定义下载命令\n            await invoke('download_file', {\n                url: urlToDownload,\n                savePath: '', // 留空通常意味着 Pake 会使用默认下载路径\n                fileId: fileId,\n            });\n\n            // 下载完成后，从跟踪集合中移除\n            downloadingFiles.delete(fileId);\n            \n            // 使用 Tauri 的原生对话框提示用户\n            await message('下载完成！', { title: '提示', type: 'info' });\n\n        } catch (err) {\n            // 如果下载出错\n            console.error('下载失败:', err);\n            downloadingFiles.delete(fileId);\n            await message(`下载失败: ${err}`, { title: '错误', type: 'error' });\n        }\n    };\n\n    // 将新的下载钩子也添加到 document 的点击事件监听器中\n    document.addEventListener('click', hookDownload, { capture: true });\n\n})(); // 使用立即执行函数表达式(IIFE)封装，避免污染全局作用域\n// ---------------------- [修改结束] ----------------------\n","isHtml":false,"htmlPath":"","htmlFiles":[],"prefix":"","pcRepo":"PakePlus-v2.1.3","iosRepo":"PakePlus-iOS-v2.1.3","androidRepo":"PakePlus-Android-v2.1.3","more":{"windows":{"label":"","title":"Jellyfish","url":"https://jellyfishiland.netlify.app/","userAgent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/130.0.0.0 Safari/537.36","width":800,"height":600,"theme":null,"resizable":true,"fullscreen":false,"maximized":false,"minWidth":400,"minHeight":300,"maxWidth":1920,"maxHeight":1080,"decorations":true,"transparent":false,"titleBarStyle":"Visible","visible":true,"focus":true,"closable":true,"minimizable":true,"maximizable":true,"alwaysOnTop":false,"alwaysOnBottom":false,"center":false,"shadow":true,"skipTaskbar":false,"tabbingIdentifier":null,"parent":null,"dragDropEnabled":true,"browserExtensionsEnabled":false,"devtools":true,"contentProtected":false,"hiddenTitle":false,"incognito":false,"proxyUrl":null,"useHttpsScheme":false,"zoomHotkeysEnabled":false,"acceptFirstMouse":false,"create":false,"backgroundColor":null,"backgroundThrottling":null,"javascriptDisabled":false}},"phone":{"safeArea":{"top":0,"bottom":0,"left":0,"right":0},"header":{"show":false,"title":"","backgroundColor":"","color":"","fontSize":16,"fontWeight":"bold","loading":false,"toolBar":false,"toolBarBackgroundColor":"","toolBarColor":"","toolBarFontSize":16,"toolBarFontWeight":"bold"},"siderMenu":{"show":false,"width":0,"backgroundColor":"","color":"","fontSize":16,"fontWeight":"bold","title":"","titleColor":"","titleFontSize":16,"titleFontWeight":"bold"},"tabBar":{"show":false,"backgroundColor":"","color":"","activeColor":"","fontSize":16,"fontWeight":"bold","tabBarItem":[]},"webview":{"userAgent":"","javaScriptEnabled":true,"domStorageEnabled":true,"allowFileAccess":true,"loadWithOverviewMode":true,"setSupportZoom":true,"clearCache":true}},"ios":{"name":"daefabbbfa","showName":"Jellyfish","version":"0.0.1","webUrl":"https://jellyfishiland.netlify.app/","id":"com.jellyfishiland.app.ios","icon":"./app-icon.png","desc":"Package for personal use only, please do not use for commercial purposes（打包仅限个人使用，请勿传播或商业用途）","pubBody":"Package for personal use only, please do not use for commercial purposes（打包仅限个人使用，请勿传播或商业用途）","isHtml":false,"debug":false,"safeArea":"all"},"android":{"name":"daefabbbfa","showName":"Jellyfish","version":"0.0.1","webUrl":"https://jellyfishiland.netlify.app/","id":"com.jellyfishiland.app.android","icon":"./app-icon.png","input":"./app-icon.png","output":"./res","rounded":true,"copyTo":"./app/src/main/res","androidResDir":"./app/src/main/res","desc":"Package for personal use only, please do not use for commercial purposes（打包仅限个人使用，请勿传播或商业用途）","pubBody":"Package for personal use only, please do not use for commercial purposes（打包仅限个人使用，请勿传播或商业用途）","isHtml":false,"debug":false,"safeArea":"all"},"desktop":{"name":"daefabbbfa","showName":"Jellyfish","version":"0.0.1","id":"com.jellyfishiland.app.desktop","desc":"打包仅限个人使用，请勿传播或商业用途，否则后果自负","webUrl":"https://jellyfishiland.netlify.app/","iconPath":"../app-icon.png","inputPath":"../app-icon.png","tempPath":"./processed-image.png","icnsPath":"../src-tauri/icons/icon.icns","pubBody":"打包仅限个人使用，请勿传播或商业用途，否则后果自负","isHtml":false,"single":true,"state":true,"injectJq":false,"tauriApi":false,"buildMethod":"local","debug":false}}